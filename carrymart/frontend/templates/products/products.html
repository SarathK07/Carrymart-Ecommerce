{% extends 'products/dashboard.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">üõç Products</h2>

    <div id="message" class="text-center text-danger fw-semibold mb-3"></div>
    <div id="products" class="row g-4 d-none"></div>
</div>

<style>
/* Hover effect for card */
.product-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}
.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
/* Overlay for buttons on hover */
.card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.2s;
}
.card-container:hover .card-overlay {
    opacity: 1;
}
.card-overlay button {
    margin: 0 5px;
}
</style>

<script>
const API_URL = "http://127.0.0.1:8000/products/";
const token = localStorage.getItem("token");

const messageDiv = document.getElementById("message");
const productsDiv = document.getElementById("products");

if (!token) {
    messageDiv.innerHTML = "You must login first to view products.";
} else {
    fetch(API_URL, {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        }
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            throw new Error("Unauthorized - invalid or expired token");
        }
        return response.json();
    })
    .then(data => {
        if (!Array.isArray(data)) {
            messageDiv.innerHTML = "Session expired. Please login again.";
            return;
        }

        if (data.length === 0) {
            messageDiv.innerHTML = "No products found.";
            return;
        }

        productsDiv.classList.remove("d-none");

        data.forEach(product => {
            const imageUrl = product.image.startsWith("http")
                ? product.image
                : "http://127.0.0.1:8000" + product.image;

            productsDiv.innerHTML += `
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="card card-container h-100 shadow-sm border-0 product-card position-relative">
                        <img src="${imageUrl}" class="card-img-top" style="height:200px; object-fit:cover;" alt="${product.name}">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">${product.name}</h6>
                            <p class="card-text small text-muted flex-grow-1">${product.description}</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="fw-bold text-primary">‚Çπ${product.price}</span>
                            </div>
                        </div>
                        <!-- Overlay Buttons -->
                        <div class="card-overlay">
                            <button class="btn btn-sm btn-light" onclick="viewProduct(${product.id})">View</button>
                            <button class="btn btn-sm btn-warning" onclick="addToCart(${product.id})">Add to Cart</button>
                        </div>
                    </div>
                </div>`;
        });
    })
    .catch(error => {
        messageDiv.innerHTML = "Login expired or invalid token. Please login again.";
        console.error("Auth error:", error);
    });
}

// Functions for buttons
function viewProduct(productId) {
    window.location.href = `/products/${productId}/`;
}
function addToCart(productId) {
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Please login to add products to cart!");
        return;
    }

    fetch("http://127.0.0.1:8000/cart/add/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: 1
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.message) {
            alert(data.message);

            // ‚úÖ Update cart count in navbar immediately
            fetch("http://127.0.0.1:8000/cart/viewcart/", {
                headers: { "Authorization": `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(cartData => {
                document.getElementById("cart-count").innerText = cartData.length;
            });

        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(err => {
        console.error(err);
        alert("Failed to add product to cart.");
    });
}

</script>
{% endblock %}
